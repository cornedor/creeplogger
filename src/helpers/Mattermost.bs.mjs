'use server';
// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Summary from "./Summary.bs.mjs";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.mjs";
import * as RescriptCore from "@rescript/core/src/RescriptCore.bs.mjs";
import * as OpenSkillRating from "./OpenSkillRating.bs.mjs";
import * as Primitive_option from "@rescript/runtime/lib/es6/Primitive_option.js";

let url = process.env.MATTERMOST_URL;

let isEnabled = process.env.MATTERMOST_ENABLED === "true";

function publishMessage(message) {
  if (url !== undefined) {
    if (isEnabled) {
      return fetch(Primitive_option.valFromOption(url), {
        method: "POST",
        body: Primitive_option.some(Core__Option.getExn(JSON.stringify({
          text: message
        }), undefined))
      });
    } else {
      return;
    }
  } else if (isEnabled) {
    return RescriptCore.panic("MATTERMOST_URL not set");
  } else {
    return;
  }
}

async function sendCreepsUpdate(bluePlayers, redPlayers, blueScore, redScore, points) {
  let blueNames = bluePlayers.map(player => {
    let handle = player.mattermostHandle;
    if (handle !== undefined) {
      return `@` + handle;
    } else {
      return player.name;
    }
  }).join(", ");
  let redNames = redPlayers.map(player => {
    let handle = player.mattermostHandle;
    if (handle !== undefined) {
      return `@` + handle;
    } else {
      return player.name;
    }
  }).join(", ");
  let winningTeam = blueScore > redScore ? "Blue" : "Red";
  let match;
  if (winningTeam === "Blue") {
    match = OpenSkillRating.calculateScore(bluePlayers, redPlayers, "Foosball");
  } else {
    let match$1 = OpenSkillRating.calculateScore(redPlayers, bluePlayers, "Foosball");
    match = [
      match$1[0],
      match$1[1],
      match$1[2]
    ];
  }
  let formatHandleOrName = player => {
    let handle = player.mattermostHandle;
    if (handle !== undefined) {
      return `@` + handle;
    } else {
      return player.name;
    }
  };
  let winnersStr = match[0].map(player => {
    let delta = OpenSkillRating.toDisplayDelta(player.lastOpenSkillChange);
    let sign = delta >= 0 ? "+" : "";
    return formatHandleOrName(player) + ` (` + sign + delta.toString() + `)`;
  }).join(", ");
  let losersStr = match[1].map(player => {
    let delta = OpenSkillRating.toDisplayDelta(player.lastOpenSkillChange);
    let sign = delta >= 0 ? "+" : "";
    return formatHandleOrName(player) + ` (` + sign + delta.toString() + `)`;
  }).join(", ");
  let blueIndividuals;
  blueIndividuals = winningTeam === "Blue" ? winnersStr : losersStr;
  let redIndividuals;
  redIndividuals = winningTeam === "Blue" ? losersStr : winnersStr;
  let blueWinProb = OpenSkillRating.getWinProbability(bluePlayers, redPlayers) * 100.0;
  let redWinProb = 100.0 - blueWinProb;
  let blueProbRounded = Math.round(blueWinProb * 10.0) / 10.0;
  let redProbRounded = Math.round(redWinProb * 10.0) / 10.0;
  let blueProbStr = blueProbRounded.toString();
  let redProbStr = redProbRounded.toString();
  let winnersProb;
  winnersProb = winningTeam === "Blue" ? blueWinProb : redWinProb;
  let losersProb;
  losersProb = winningTeam === "Blue" ? redWinProb : blueWinProb;
  let sprokkelTitle = winnersProb > 80.0 ? "**SPROKKEL ALERT!** ðŸš¨ðŸš¨ðŸš¨\n\n" : "";
  let losingFavoriteImage = losersProb > 80.0 ? "\n\n![](https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExMDg4OXM2NDViaTU3Y21lZWFxam93YThyeXNkNzBkeGl0cTlucWhtYiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/mcH0upG1TeEak/giphy.gif)\n" : "";
  let message = sprokkelTitle + (`### Nieuw potje geregistreerd!

| Team | Spelers | Goals |
| ---- | ------- | ----- |
| Blauw | ` + blueNames + ` | ` + blueScore.toString() + ` |
| Rood | ` + redNames + ` | ` + redScore.toString() + ` |

Individueel:
- Blauw: ` + blueIndividuals + `
- Rood: ` + redIndividuals + `

OpenSkill winstkans (pre-game): Blauw ` + blueProbStr + `% vs Rood ` + redProbStr + `%
`) + losingFavoriteImage;
  let promise = publishMessage(message);
  if (promise !== undefined) {
    await promise;
  }
  return 0;
}

async function sendDartsUpdate(winners, losers, points, mode) {
  let winnerNames = winners.map(player => {
    let handle = player.mattermostHandle;
    if (handle !== undefined) {
      return `@` + handle;
    } else {
      return player.name;
    }
  }).join(", ");
  let loserNames = losers.map(player => {
    let handle = player.mattermostHandle;
    if (handle !== undefined) {
      return `@` + handle;
    } else {
      return player.name;
    }
  }).join(", ");
  let message = `### ðŸŽ¯ Nieuw darts potje geregistreerd!

Winnaar: ` + winnerNames + ` (+` + points.toString() + `)
Verliezer: ` + loserNames + ` (-` + points.toString() + `)
Game mode: ` + mode + `
`;
  let promise = publishMessage(message);
  if (promise !== undefined) {
    await promise;
  }
  return 0;
}

async function sendDailyUpdate() {
  let overview = await Summary.getDailyOverview("Daily");
  let overviewArray = Array.from(overview.values()).toSorted((a, b) => {
    let a$1 = ((a.creeps << 16) - (a.games << 8) | 0) - a.score | 0;
    let b$1 = ((b.creeps << 16) - (b.games << 8) | 0) - b.score | 0;
    return b$1 - a$1;
  });
  let match = overviewArray.length;
  if (match === 0) {
    return false;
  }
  let table = overviewArray.map((creeper, index) => "| " + (index + 1 | 0).toString() + " | " + creeper.name + " | " + creeper.creeps.toString() + " | " + creeper.games.toString() + " | " + creeper.score.toString() + " |").join("\n");
  let topCreeper = Core__Option.getExn(overviewArray[0], undefined);
  let intro = `### De kruip statistieken van vandaag zijn bekend!

Feliciteer direct onze top kruiper van de dag: ` + topCreeper.name + ` met maar liefst ` + topCreeper.creeps.toString() + ` kruipjes en een netto score van ` + topCreeper.score.toString() + `!

| # | Naam | Kruipjes | Potjes | Netto Score |
| - | ---- | -------- | ------ | ----------- |
` + table + `

`;
  let prom = publishMessage(intro);
  if (prom !== undefined) {
    await prom;
    return true;
  } else {
    console.log(intro);
    return false;
  }
}

async function sendDaysWithoutReset(name) {
  let message = name + ` is reset`;
  let promise = publishMessage(message);
  if (promise !== undefined) {
    await promise;
  }
  return 0;
}

export {
  sendCreepsUpdate,
  sendDartsUpdate,
  publishMessage,
  sendDailyUpdate,
  sendDaysWithoutReset,
}
/* url Not a pure module */
